# Patient Payor Information Enhancement Plan

## Overview
This document outlines the technical implementation plan for enhancing the patient registration system with comprehensive payor information collection capabilities. The enhancement includes adding payor type and detail selection with dynamic dropdowns, insurance policy details, and guarantor information to the patient registration process.

## Requirements
1. Add payor type dropdown (Insurance, Company, Stakeholder)
2. Add dynamic payor detail dropdown that populates based on selected payor type
3. Add insurance policy/ID number field
4. Add insurance group number field
5. Add guarantor information fields (name, relationship, phone, address)
6. Fields should be displayed in patient registration and edit forms
7. Data should be stored persistently in the database
8. Solution should maintain compliance with healthcare billing standards

## 1. Database Schema Changes

### New Tables
- `payor_types` - Stores different types of payors
- `payor_details` - Stores specific payor details linked to payor types

### Modified Fields in Patient Table
- `payor_type` (String, 50 characters) - Type of payor (Insurance, Company, Stakeholder)
- `payor_detail` (String, 100 characters) - Specific payor detail
- `insurance_policy_id` (String, 50 characters) - Insurance policy/ID number
- `insurance_group_number` (String, 50 characters) - Insurance group number
- `guarantor_name` (String, 100 characters) - Guarantor's full name
- `guarantor_relationship` (String, 50 characters) - Relationship to patient
- `guarantor_phone` (String, 20 characters) - Guarantor's phone number
- `guarantor_address` (String, 255 characters) - Guarantor's address

### Migration Script
Create a new Alembic migration script to add these tables and columns:

```python
"""Payor information

Revision ID: 691a2e0fbd3e
Revises: 841a5adb64eb
Create Date: 2025-08-15 07:37:40.211161

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '691a2e0fbd3e'
down_revision = '841a5adb64eb'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('payor_types',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.Column('description', sa.String(length=255), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_table('payor_details',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.String(length=255), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('payor_type_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['payor_type_id'], ['payor_types.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('patient', schema=None) as batch_op:
        batch_op.add_column(sa.Column('payor_type', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('payor_detail', sa.String(length=100), nullable=True))
        batch_op.drop_column('insurance_provider')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('patient', schema=None) as batch_op:
        batch_op.add_column(sa.Column('insurance_provider', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.drop_column('payor_detail')
        batch_op.drop_column('payor_type')

    op.drop_table('payor_details')
    op.drop_table('payor_types')
    # ### end Alembic commands ###
```

## 2. Model Updates

Update `app/patients/models.py` to include the new fields in the Patient model:

```python
# Add these fields to the Patient class
payor_type = db.Column(db.String(50), nullable=True)  # Insurance, Company, Stakeholder
payor_detail = db.Column(db.String(100), nullable=True)  # Specific insurance company, company name, or stakeholder name
insurance_policy_id = db.Column(db.String(50), nullable=True)
insurance_group_number = db.Column(db.String(50), nullable=True)
guarantor_name = db.Column(db.String(100), nullable=True)
guarantor_relationship = db.Column(db.String(50), nullable=True)
guarantor_phone = db.Column(db.String(20), nullable=True)
guarantor_address = db.Column(db.String(255), nullable=True)
```

Also add the new PayorType and PayorDetail models to `app/system_params/models.py`:

```python
# Payor models for managing payor types and details
class PayorType(db.Model):
    __tablename__ = 'payor_types'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), unique=True, nullable=False)
    description = db.Column(db.String(255))
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=db.func.current_timestamp())
    updated_at = db.Column(db.DateTime, default=db.func.current_timestamp(), onupdate=db.func.current_timestamp())
    
    # Relationship to payor details
    payor_details = db.relationship('PayorDetail', backref='payor_type', lazy=True, cascade='all, delete-orphan')
    
    def __repr__(self):
        return f'<PayorType {self.name}>'

class PayorDetail(db.Model):
    __tablename__ = 'payor_details'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.String(255))
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=db.func.current_timestamp())
    updated_at = db.Column(db.DateTime, default=db.func.current_timestamp(), onupdate=db.func.current_timestamp())
    
    # Foreign key to payor type
    payor_type_id = db.Column(db.Integer, db.ForeignKey('payor_types.id'), nullable=False)
    
    def __repr__(self):
        return f'<PayorDetail {self.name} ({self.payor_type.name})>'
```

## 3. Form Updates

Update `app/patients/forms.py` to include the new fields in both PatientForm and PatientRegistrationForm:

### Add these fields to PatientForm:
```python
payor_type = SelectField('Payor Type', choices=[('', 'Select Payor Type'), ('Insurance', 'Insurance'), ('Company', 'Company'), ('Stakeholder', 'Stakeholder')], validators=[Optional()], default='')
payor_detail = SelectField('Payor Detail', choices=[('', 'Select Payor Type First')], validators=[Optional()], default='')
insurance_policy_id = StringField('Insurance Policy/ID Number')
insurance_group_number = StringField('Insurance Group Number')
guarantor_name = StringField('Guarantor Name')
guarantor_relationship = StringField('Guarantor Relationship to Patient')
guarantor_phone = StringField('Guarantor Phone')
guarantor_address = TextAreaField('Guarantor Address')
```

### Add forms for managing payor configurations to `app/system_params/forms.py`:
```python
class PayorTypeForm(FlaskForm):
    name = StringField('Payor Type Name', validators=[DataRequired()])
    description = TextAreaField('Description', validators=[Optional()])
    is_active = BooleanField('Active', default=True)
    submit = SubmitField('Save Payor Type')

class PayorDetailForm(FlaskForm):
    name = StringField('Payor Detail Name', validators=[DataRequired()])
    description = TextAreaField('Description', validators=[Optional()])
    payor_type_id = SelectField('Payor Type', coerce=int, validators=[DataRequired()])
    is_active = BooleanField('Active', default=True)
    submit = SubmitField('Save Payor Detail')
```

## 4. Template Updates

### Update `app/templates/patients/new.html`

Modify the Insurance Information section to include the new fields:

```html
<!-- Payor Information Section -->
<section class="card payor-info-section" aria-labelledby="payor-info-heading">
    <div class="card-header">
        <h2 id="payor-info-heading" class="card-title">Payor Information</h2>
    </div>
    <div class="card-body">
        <div class="mb-3">
            {{ form.payor_type.label(class="form-label") }}
            {% if form.payor_type.errors %}
                {{ form.payor_type(class="form-select", class_="form-select is-invalid", id="payor-type") }}
                <div class="invalid-feedback">
                    {% for error in form.payor_type.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% else %}
                {{ form.payor_type(class="form-select", id="payor-type") }}
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.payor_detail.label(class="form-label") }}
            {% if form.payor_detail.errors %}
                {{ form.payor_detail(class="form-select", class_="form-select is-invalid", id="payor-detail") }}
                <div class="invalid-feedback">
                    {% for error in form.payor_detail.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% else %}
                {{ form.payor_detail(class="form-select", id="payor-detail") }}
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.insurance_policy_id.label(class="form-label") }}
            <div class="input-group">
                {% if form.insurance_policy_id.errors %}
                    {{ form.insurance_policy_id(class="form-control", class_="form-control is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.insurance_policy_id.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.insurance_policy_id(class="form-control") }}
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            {{ form.insurance_group_number.label(class="form-label") }}
            <div class="input-group">
                {% if form.insurance_group_number.errors %}
                    {{ form.insurance_group_number(class="form-control", class_="form-control is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.insurance_group_number.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.insurance_group_number(class="form-control") }}
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            {{ form.guarantor_name.label(class="form-label") }}
            <div class="input-group">
                {% if form.guarantor_name.errors %}
                    {{ form.guarantor_name(class="form-control", class_="form-control is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.guarantor_name.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.guarantor_name(class="form-control") }}
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            {{ form.guarantor_relationship.label(class="form-label") }}
            <div class="input-group">
                {% if form.guarantor_relationship.errors %}
                    {{ form.guarantor_relationship(class="form-control", class_="form-control is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.guarantor_relationship.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.guarantor_relationship(class="form-control") }}
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            {{ form.guarantor_phone.label(class="form-label") }}
            <div class="input-group">
                {% if form.guarantor_phone.errors %}
                    {{ form.guarantor_phone(class="form-control", class_="form-control is-invalid", type="tel") }}
                    <div class="invalid-feedback">
                        {% for error in form.guarantor_phone.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.guarantor_phone(class="form-control", type="tel") }}
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            {{ form.guarantor_address.label(class="form-label") }}
            <div class="input-group">
                {% if form.guarantor_address.errors %}
                    {{ form.guarantor_address(class="form-control", class_="form-control is-invalid", rows="3") }}
                    <div class="invalid-feedback">
                        {% for error in form.guarantor_address.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.guarantor_address(class="form-control", rows="3") }}
                {% endif %}
            </div>
        </div>
    </div>
</section>
```

### Update `app/templates/patients/edit.html`

Apply the same changes to the edit template's Payor Information section.

### Add admin templates for managing payor configurations

Create `app/templates/admin/system_params/payor_types.html`:
```html
{% extends "admin/base.html" %}

{% block content %}
<div class="container">
    <h1>Payor Types</h1>
    
    <div class="mb-3">
        <a href="{{ url_for('system_params.create_payor_type') }}" class="btn btn-primary">Add New Payor Type</a>
    </div>
    
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Active</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for payor_type in payor_types %}
            <tr>
                <td>{{ payor_type.name }}</td>
                <td>{{ payor_type.description or '' }}</td>
                <td>{{ 'Yes' if payor_type.is_active else 'No' }}</td>
                <td>{{ payor_type.created_at.strftime('%Y-%m-%d') if payor_type.created_at else '' }}</td>
                <td>
                    <a href="{{ url_for('system_params.edit_payor_type', id=payor_type.id) }}" class="btn btn-sm btn-primary">Edit</a>
                    <form method="POST" action="{{ url_for('system_params.delete_payor_type', id=payor_type.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this payor type?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
```

Create `app/templates/admin/system_params/payor_type_form.html`:
```html
{% extends "admin/base.html" %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>
    
    <form method="POST">
        {{ form.hidden_tag() }}
        
        <div class="mb-3">
            {{ form.name.label(class="form-label") }}
            {{ form.name(class="form-control") }}
            {% if form.name.errors %}
                <div class="text-danger">
                    {% for error in form.name.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", rows="3") }}
            {% if form.description.errors %}
                <div class="text-danger">
                    {% for error in form.description.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3 form-check">
            {{ form.is_active(class="form-check-input") }}
            {{ form.is_active.label(class="form-check-label") }}
        </div>
        
        <div class="mb-3">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('system_params.manage_payor_types') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}
```

Create `app/templates/admin/system_params/payor_details.html`:
```html
{% extends "admin/base.html" %}

{% block content %}
<div class="container">
    <h1>Payor Details</h1>
    
    <div class="mb-3">
        <a href="{{ url_for('system_params.create_payor_detail') }}" class="btn btn-primary">Add New Payor Detail</a>
    </div>
    
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Payor Type</th>
                <th>Description</th>
                <th>Active</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for payor_detail in payor_details %}
            <tr>
                <td>{{ payor_detail.name }}</td>
                <td>{{ payor_detail.payor_type.name }}</td>
                <td>{{ payor_detail.description or '' }}</td>
                <td>{{ 'Yes' if payor_detail.is_active else 'No' }}</td>
                <td>{{ payor_detail.created_at.strftime('%Y-%m-%d') if payor_detail.created_at else '' }}</td>
                <td>
                    <a href="{{ url_for('system_params.edit_payor_detail', id=payor_detail.id) }}" class="btn btn-sm btn-primary">Edit</a>
                    <form method="POST" action="{{ url_for('system_params.delete_payor_detail', id=payor_detail.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this payor detail?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
```

Create `app/templates/admin/system_params/payor_detail_form.html`:
```html
{% extends "admin/base.html" %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>
    
    <form method="POST">
        {{ form.hidden_tag() }}
        
        <div class="mb-3">
            {{ form.name.label(class="form-label") }}
            {{ form.name(class="form-control") }}
            {% if form.name.errors %}
                <div class="text-danger">
                    {% for error in form.name.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.payor_type_id.label(class="form-label") }}
            {{ form.payor_type_id(class="form-select") }}
            {% if form.payor_type_id.errors %}
                <div class="text-danger">
                    {% for error in form.payor_type_id.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", rows="3") }}
            {% if form.description.errors %}
                <div class="text-danger">
                    {% for error in form.description.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3 form-check">
            {{ form.is_active(class="form-check-input") }}
            {{ form.is_active.label(class="form-check-label") }}
        </div>
        
        <div class="mb-3">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('system_params.manage_payor_details') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}
```

## 5. Route Updates

Update `app/patients/routes.py` to handle the new payor fields:

### In the create_patient function:
```python
# Replace insurance_provider with payor_type and payor_detail
payor_type=form.payor_type.data,
payor_detail=form.payor_detail.data,
insurance_policy_id=form.insurance_policy_id.data,
insurance_group_number=form.insurance_group_number.data,
guarantor_name=form.guarantor_name.data,
guarantor_relationship=form.guarantor_relationship.data,
guarantor_phone=form.guarantor_phone.data,
guarantor_address=form.guarantor_address.data,
```

### In the edit_patient function:
```python
# Replace insurance_provider with payor_type and payor_detail
patient.payor_type = form.payor_type.data
patient.payor_detail = form.payor_detail.data
patient.insurance_policy_id = form.insurance_policy_id.data
patient.insurance_group_number = form.insurance_group_number.data
patient.guarantor_name = form.guarantor_name.data
patient.guarantor_relationship = form.guarantor_relationship.data
patient.guarantor_phone = form.guarantor_phone.data
patient.guarantor_address = form.guarantor_address.data
```

Add routes for managing payor configurations to `app/system_params/routes.py`:
```python
@bp.route('/admin/system-params/payor-types', methods=['GET'])
@roles_required('Admin')
def manage_payor_types():
    payor_types = PayorType.query.all()
    return render_template('admin/system_params/payor_types.html', payor_types=payor_types)

@bp.route('/admin/system-params/payor-types/new', methods=['GET', 'POST'])
@roles_required('Admin')
def create_payor_type():
    form = PayorTypeForm()
    if form.validate_on_submit():
        payor_type = PayorType(
            name=form.name.data,
            description=form.description.data,
            is_active=form.is_active.data
        )
        db.session.add(payor_type)
        db.session.commit()
        flash('Payor type created successfully', 'success')
        return redirect(url_for('system_params.manage_payor_types'))
    return render_template('admin/system_params/payor_type_form.html', form=form, title='Create Payor Type')

@bp.route('/admin/system-params/payor-types/<int:id>/edit', methods=['GET', 'POST'])
@roles_required('Admin')
def edit_payor_type(id):
    payor_type = PayorType.query.get_or_404(id)
    form = PayorTypeForm(obj=payor_type)
    if form.validate_on_submit():
        payor_type.name = form.name.data
        payor_type.description = form.description.data
        payor_type.is_active = form.is_active.data
        db.session.commit()
        flash('Payor type updated successfully', 'success')
        return redirect(url_for('system_params.manage_payor_types'))
    return render_template('admin/system_params/payor_type_form.html', form=form, title='Edit Payor Type')

@bp.route('/admin/system-params/payor-types/<int:id>/delete', methods=['POST'])
@roles_required('Admin')
def delete_payor_type(id):
    payor_type = PayorType.query.get_or_404(id)
    db.session.delete(payor_type)
    db.session.commit()
    flash('Payor type deleted successfully', 'success')
    return redirect(url_for('system_params.manage_payor_types'))

@bp.route('/admin/system-params/payor-details', methods=['GET'])
@roles_required('Admin')
def manage_payor_details():
    payor_details = PayorDetail.query.join(PayorType).all()
    return render_template('admin/system_params/payor_details.html', payor_details=payor_details)

@bp.route('/admin/system-params/payor-details/new', methods=['GET', 'POST'])
@roles_required('Admin')
def create_payor_detail():
    form = PayorDetailForm()
    # Populate payor type choices
    form.payor_type_id.choices = [(pt.id, pt.name) for pt in PayorType.query.all()]
    if form.validate_on_submit():
        payor_detail = PayorDetail(
            name=form.name.data,
            description=form.description.data,
            payor_type_id=form.payor_type_id.data,
            is_active=form.is_active.data
        )
        db.session.add(payor_detail)
        db.session.commit()
        flash('Payor detail created successfully', 'success')
        return redirect(url_for('system_params.manage_payor_details'))
    return render_template('admin/system_params/payor_detail_form.html', form=form, title='Create Payor Detail')

@bp.route('/admin/system-params/payor-details/<int:id>/edit', methods=['GET', 'POST'])
@roles_required('Admin')
def edit_payor_detail(id):
    payor_detail = PayorDetail.query.get_or_404(id)
    form = PayorDetailForm(obj=payor_detail)
    # Populate payor type choices
    form.payor_type_id.choices = [(pt.id, pt.name) for pt in PayorType.query.all()]
    if form.validate_on_submit():
        payor_detail.name = form.name.data
        payor_detail.description = form.description.data
        payor_detail.payor_type_id = form.payor_type_id.data
        payor_detail.is_active = form.is_active.data
        db.session.commit()
        flash('Payor detail updated successfully', 'success')
        return redirect(url_for('system_params.manage_payor_details'))
    return render_template('admin/system_params/payor_detail_form.html', form=form, title='Edit Payor Detail')

@bp.route('/admin/system-params/payor-details/<int:id>/delete', methods=['POST'])
@roles_required('Admin')
def delete_payor_detail(id):
    payor_detail = PayorDetail.query.get_or_404(id)
    db.session.delete(payor_detail)
    db.session.commit()
    flash('Payor detail deleted successfully', 'success')
    return redirect(url_for('system_params.manage_payor_details'))
```

## 6. JavaScript for Dynamic Dropdowns

Add JavaScript to handle the dynamic payor detail dropdown in `app/templates/patients/new.html` and `app/templates/patients/edit.html`:

```javascript
// Dynamic payor dropdowns
const payorTypeSelect = document.getElementById('payor-type');
const payorDetailSelect = document.getElementById('payor-detail');

// Sample data for payor details based on payor type
// In a real application, this would come from an API
const payorDetails = {
    'Insurance': ['BPJS', 'AdMedika', 'Aetna', 'Allianz', 'Cigna', 'Prudential'],
    'Company': ['PT. Medistra Hospital', 'PT. Healthcare Corp', 'PT. Medical Solutions', 'PT. Wellness Group'],
    'Stakeholder': ['Government', 'NGO', 'Private Donor', 'International Aid']
};

// Initialize payor detail dropdown based on existing payor type (for edit form)
const initialPayorType = payorTypeSelect.value;
if (initialPayorType && payorDetails[initialPayorType]) {
    // Clear existing options
    payorDetailSelect.innerHTML = '';
    
    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select ' + initialPayorType + ' Detail';
    payorDetailSelect.appendChild(defaultOption);
    
    // Add options based on initial payor type
    payorDetails[initialPayorType].forEach(function(detail) {
        const option = document.createElement('option');
        option.value = detail;
        option.textContent = detail;
        if (option.value === payorDetailSelect.getAttribute('data-initial-value')) {
            option.selected = true;
        }
        payorDetailSelect.appendChild(option);
    });
}

payorTypeSelect.addEventListener('change', function() {
    const selectedType = this.value;
    // Clear existing options
    payorDetailSelect.innerHTML = '';
    
    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select ' + (selectedType ? selectedType + ' Detail' : 'Payor Type First');
    payorDetailSelect.appendChild(defaultOption);
    
    // Add options based on selected payor type
    if (selectedType && payorDetails[selectedType]) {
        payorDetails[selectedType].forEach(function(detail) {
            const option = document.createElement('option');
            option.value = detail;
            option.textContent = detail;
            payorDetailSelect.appendChild(option);
        });
    }
    
    // Enable/disable payor detail dropdown
    payorDetailSelect.disabled = !selectedType;
});

// Set initial state of payor detail dropdown
if (payorTypeSelect.value === '') {
    payorDetailSelect.disabled = true;
} else {
    payorDetailSelect.disabled = false;
}
```

## 7. CSS Updates

Add CSS styles for the payor information section in `app/static/css/patient-registration.css`:

```css
/* Payor information section styles */
.payor-info-section .form-select {
  margin-bottom: 1rem;
}

.payor-info-section .form-label {
  font-weight: 600;
  color: #495057;
}

/* Dynamic dropdown styles */
#payor-detail:disabled {
  background-color: #e9ecef;
  opacity: 0.7;
}

/* Responsive adjustments for payor section */
@media (max-width: 768px) {
  .payor-info-section .form-select {
    margin-bottom: 0.75rem;
  }
}
```

## 8. Data Migration Strategy

For existing patients, the new fields will be initialized with NULL values, which is the standard behavior for adding new columns to existing tables. No special data migration is required.

## 9. Compliance Considerations

### HIPAA Compliance
- All payor and guarantor information will be treated with the same level of security as other patient data
- Data will be stored encrypted in the database
- Access controls will be maintained through the existing authentication and authorization mechanisms

### Data Validation
- Form validation will be implemented for all new fields using WTForms validators
- Appropriate length limits will be enforced to prevent data overflow
- Phone number format validation will be implemented

### Audit Trail
- Changes to payor information will be tracked through the existing created_at and created_by fields
- Consider implementing a more comprehensive audit trail system in future enhancements

## 10. Implementation Steps

1. Update the Patient model in `app/patients/models.py`
2. Create the PayorType and PayorDetail models in `app/system_params/models.py`
3. Create the database migration script
4. Apply the database migration
5. Update the forms in `app/patients/forms.py` and `app/system_params/forms.py`
6. Update the routes in `app/patients/routes.py` and `app/system_params/routes.py`
7. Update the templates (`app/templates/patients/new.html` and `app/templates/patients/edit.html`)
8. Add admin templates for managing payor configurations
9. Add CSS styles for the new sections
10. Add JavaScript for dynamic dropdowns
11. Test the implementation with new and existing patient records

## 11. Testing Considerations

- Verify that new fields are properly displayed in both registration and edit forms
- Test data validation for all new fields
- Verify that data is properly saved to and retrieved from the database
- Test with existing patient records to ensure backward compatibility
- Verify that the application handles NULL values gracefully for existing patients
- Test the dynamic dropdown functionality
- Test the admin interface for managing payor configurations

## 12. Future Enhancements

- Implement a more sophisticated payor management system with API integration
- Add support for multiple payors per patient
- Implement more comprehensive audit trails for patient data changes
- Add integration with external insurance verification services
- Add support for payor contracts and pricing agreements